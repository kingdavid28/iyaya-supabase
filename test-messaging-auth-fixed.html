<!DOCTYPE html>
<html>
<head>
    <title>Firebase Messaging Test - Auth Fixed</title>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, push, set, onValue, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyC7Flwhydbq1qV3tw_QchXr8_5Wg0wOshk",
            authDomain: "iyayav0.firebaseapp.com",
            databaseURL: "https://iyayav0-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "iyayav0",
            storageBucket: "iyayav0.firebasestorage.app",
            messagingSenderId: "433110030942",
            appId: "1:433110030942:web:831e0450381ef9b318f2cf"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const auth = getAuth(app);

        let isAuthenticated = false;
        const user1 = 'test_user_1';
        const user2 = 'test_user_2';
        const conversationId = [user1, user2].sort().join('_');

        // Authentication handler
        onAuthStateChanged(auth, (user) => {
            if (user) {
                isAuthenticated = true;
                console.log('‚úÖ Authenticated as:', user.uid);
                document.getElementById('authStatus').innerHTML = `‚úÖ Authenticated as: ${user.uid}`;
                setupMessageListener();
            } else {
                isAuthenticated = false;
                console.log('‚ùå Not authenticated');
                document.getElementById('authStatus').innerHTML = '‚ùå Not authenticated';
            }
        });

        // Authenticate anonymously
        async function authenticate() {
            try {
                const result = await signInAnonymously(auth);
                console.log('‚úÖ Anonymous authentication successful');
                return true;
            } catch (error) {
                console.error('‚ùå Authentication failed:', error);
                document.getElementById('status').innerHTML += `<div>‚ùå Auth Error: ${error.message}</div>`;
                return false;
            }
        }

        // Send test message
        async function sendTestMessage(senderId, recipientId, text) {
            if (!isAuthenticated) {
                document.getElementById('status').innerHTML += `<div>‚ùå Not authenticated</div>`;
                return;
            }

            try {
                const messagesRef = ref(database, `conversations/${conversationId}/messages`);
                const newMessageRef = push(messagesRef);
                
                const message = {
                    id: newMessageRef.key,
                    senderId,
                    recipientId,
                    text,
                    content: text,
                    timestamp: Date.now(),
                    createdAt: Date.now(),
                    read: false
                };
                
                await set(ref(database, `conversations/${conversationId}/messages/${newMessageRef.key}`), message);
                
                const updates = {
                    [`conversations/${conversationId}/lastMessage`]: text,
                    [`conversations/${conversationId}/lastMessageTime`]: Date.now(),
                    [`conversations/${conversationId}/participants/${senderId}`]: true,
                    [`conversations/${conversationId}/participants/${recipientId}`]: true,
                    [`userConversations/${senderId}/${conversationId}`]: {
                        participantId: recipientId,
                        lastMessage: text,
                        lastMessageTime: Date.now()
                    },
                    [`userConversations/${recipientId}/${conversationId}`]: {
                        participantId: senderId,
                        lastMessage: text,
                        lastMessageTime: Date.now()
                    }
                };
                
                await update(ref(database), updates);
                console.log('‚úÖ Message sent:', text);
                document.getElementById('status').innerHTML += `<div>‚úÖ Sent: "${text}" from ${senderId}</div>`;
            } catch (error) {
                console.error('‚ùå Error sending message:', error);
                document.getElementById('status').innerHTML += `<div>‚ùå Error: ${error.message}</div>`;
            }
        }

        // Listen for messages
        function setupMessageListener() {
            const messagesRef = ref(database, `conversations/${conversationId}/messages`);
            
            onValue(messagesRef, (snapshot) => {
                console.log('üî• Messages snapshot received');
                const messages = [];
                
                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        const message = childSnapshot.val();
                        messages.push({
                            id: childSnapshot.key,
                            ...message
                        });
                    });
                }
                
                console.log('üì© Messages:', messages);
                
                const messagesDiv = document.getElementById('messages');
                messagesDiv.innerHTML = '<h3>Messages:</h3>';
                
                if (messages.length === 0) {
                    messagesDiv.innerHTML += '<div>No messages found</div>';
                } else {
                    messages.sort((a, b) => a.timestamp - b.timestamp);
                    messages.forEach(msg => {
                        messagesDiv.innerHTML += `
                            <div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px; background: ${msg.senderId === user1 ? '#e3f2fd' : '#f3e5f5'}">
                                <strong>${msg.senderId}:</strong> ${msg.text}<br>
                                <small>Time: ${new Date(msg.timestamp).toLocaleString()}</small>
                            </div>
                        `;
                    });
                }
            });
        }

        // Initialize when page loads
        window.addEventListener('load', async () => {
            console.log('üöÄ Initializing Firebase messaging test');
            
            // Authenticate first
            await authenticate();
            
            // Add event listeners
            document.getElementById('sendUser1').addEventListener('click', () => {
                const text = `Hello from User 1 at ${new Date().toLocaleTimeString()}`;
                sendTestMessage(user1, user2, text);
            });
            
            document.getElementById('sendUser2').addEventListener('click', () => {
                const text = `Hello from User 2 at ${new Date().toLocaleTimeString()}`;
                sendTestMessage(user2, user1, text);
            });
        });
    </script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        button { margin: 10px; padding: 10px 20px; }
        #messages, #status, #authStatus { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        #status { background-color: #f9f9f9; }
        #authStatus { background-color: #e8f5e9; }
    </style>
</head>
<body>
    <h1>Firebase Messaging Test - Authentication Fixed</h1>
    
    <div id="authStatus">
        <h3>Authentication Status:</h3>
        <div>Checking...</div>
    </div>
    
    <div>
        <button id="sendUser1">Send Message as User 1</button>
        <button id="sendUser2">Send Message as User 2</button>
    </div>
    
    <div id="status">
        <h3>Status:</h3>
        <div>Ready to test...</div>
    </div>
    
    <div id="messages">
        <h3>Messages:</h3>
        <div>Waiting for authentication...</div>
    </div>
</body>
</html>