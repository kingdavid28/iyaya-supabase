<!DOCTYPE html>
<html>
<head>
    <title>Firebase Messaging Debug</title>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, push, set, onValue, get, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyC7Flwhydbq1qV3tw_QchXr8_5Wg0wOshk",
            authDomain: "iyayav0.firebaseapp.com",
            databaseURL: "https://iyayav0-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "iyayav0",
            storageBucket: "iyayav0.firebasestorage.app",
            messagingSenderId: "433110030942",
            appId: "1:433110030942:web:831e0450381ef9b318f2cf"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const auth = getAuth(app);

        // Test users
        const user1 = 'test_user_1';
        const user2 = 'test_user_2';
        const conversationId = [user1, user2].sort().join('_');

        console.log('üî• Testing conversation ID:', conversationId);

        // Function to send a test message
        async function sendTestMessage(senderId, recipientId, text) {
            try {
                const messagesRef = ref(database, `conversations/${conversationId}/messages`);
                const newMessageRef = push(messagesRef);
                
                const message = {
                    id: newMessageRef.key,
                    senderId,
                    recipientId,
                    text,
                    timestamp: Date.now(),
                    read: false
                };
                
                const updates = {
                    [`conversations/${conversationId}/messages/${newMessageRef.key}`]: message,
                    [`conversations/${conversationId}/lastMessage`]: text,
                    [`conversations/${conversationId}/lastMessageTime`]: Date.now(),
                    [`conversations/${conversationId}/participants/${senderId}`]: true,
                    [`conversations/${conversationId}/participants/${recipientId}`]: true,
                    [`userConversations/${senderId}/${conversationId}`]: {
                        participantId: recipientId,
                        lastMessage: text,
                        lastMessageTime: Date.now()
                    },
                    [`userConversations/${recipientId}/${conversationId}`]: {
                        participantId: senderId,
                        lastMessage: text,
                        lastMessageTime: Date.now()
                    }
                };
                
                await update(ref(database), updates);
                console.log('‚úÖ Message sent:', text);
                document.getElementById('status').innerHTML += `<div>‚úÖ Sent: "${text}" from ${senderId}</div>`;
            } catch (error) {
                console.error('‚ùå Error sending message:', error);
                document.getElementById('status').innerHTML += `<div>‚ùå Error: ${error.message}</div>`;
            }
        }

        // Function to listen for messages
        function listenForMessages() {
            const messagesRef = ref(database, `conversations/${conversationId}/messages`);
            
            onValue(messagesRef, (snapshot) => {
                console.log('üî• Messages snapshot received');
                const messages = [];
                
                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        const message = childSnapshot.val();
                        messages.push({
                            id: childSnapshot.key,
                            ...message
                        });
                    });
                }
                
                console.log('üì© Messages:', messages);
                
                const messagesDiv = document.getElementById('messages');
                messagesDiv.innerHTML = '<h3>Messages:</h3>';
                
                if (messages.length === 0) {
                    messagesDiv.innerHTML += '<div>No messages found</div>';
                } else {
                    messages.forEach(msg => {
                        messagesDiv.innerHTML += `
                            <div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
                                <strong>${msg.senderId}:</strong> ${msg.text}<br>
                                <small>Time: ${new Date(msg.timestamp).toLocaleString()}</small>
                            </div>
                        `;
                    });
                }
            });
        }

        // Function to check conversation structure
        async function checkConversationStructure() {
            try {
                // Check main conversation
                const conversationRef = ref(database, `conversations/${conversationId}`);
                const conversationSnapshot = await get(conversationRef);
                
                console.log('üîç Conversation exists:', conversationSnapshot.exists());
                if (conversationSnapshot.exists()) {
                    console.log('üîç Conversation data:', conversationSnapshot.val());
                }
                
                // Check user conversations
                const user1ConvRef = ref(database, `userConversations/${user1}`);
                const user1Snapshot = await get(user1ConvRef);
                
                const user2ConvRef = ref(database, `userConversations/${user2}`);
                const user2Snapshot = await get(user2ConvRef);
                
                console.log('üîç User1 conversations:', user1Snapshot.exists() ? user1Snapshot.val() : 'None');
                console.log('üîç User2 conversations:', user2Snapshot.exists() ? user2Snapshot.val() : 'None');
                
                document.getElementById('structure').innerHTML = `
                    <h3>Database Structure:</h3>
                    <div><strong>Conversation ID:</strong> ${conversationId}</div>
                    <div><strong>Main conversation exists:</strong> ${conversationSnapshot.exists()}</div>
                    <div><strong>User1 conversations exist:</strong> ${user1Snapshot.exists()}</div>
                    <div><strong>User2 conversations exist:</strong> ${user2Snapshot.exists()}</div>
                `;
            } catch (error) {
                console.error('‚ùå Error checking structure:', error);
            }
        }

        // Initialize when page loads
        window.addEventListener('load', async () => {
            try {
                // Try to authenticate (this might fail due to security rules)
                await signInAnonymously(auth);
                console.log('‚úÖ Authenticated anonymously');
            } catch (error) {
                console.log('‚ö†Ô∏è Anonymous auth failed (expected):', error.message);
            }
            
            // Set up listeners
            listenForMessages();
            
            // Check initial structure
            await checkConversationStructure();
            
            // Add event listeners to buttons
            document.getElementById('sendUser1').addEventListener('click', () => {
                const text = `Hello from User 1 at ${new Date().toLocaleTimeString()}`;
                sendTestMessage(user1, user2, text);
            });
            
            document.getElementById('sendUser2').addEventListener('click', () => {
                const text = `Hello from User 2 at ${new Date().toLocaleTimeString()}`;
                sendTestMessage(user2, user1, text);
            });
            
            document.getElementById('checkStructure').addEventListener('click', checkConversationStructure);
        });
    </script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        button { margin: 10px; padding: 10px 20px; }
        #messages, #structure, #status { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        #status { background-color: #f9f9f9; }
    </style>
</head>
<body>
    <h1>Firebase Messaging Debug Test</h1>
    
    <div>
        <button id="sendUser1">Send Message as User 1</button>
        <button id="sendUser2">Send Message as User 2</button>
        <button id="checkStructure">Check Database Structure</button>
    </div>
    
    <div id="status">
        <h3>Status:</h3>
        <div>Ready to test...</div>
    </div>
    
    <div id="structure">
        <h3>Database Structure:</h3>
        <div>Loading...</div>
    </div>
    
    <div id="messages">
        <h3>Messages:</h3>
        <div>Listening for messages...</div>
    </div>
</body>
</html>