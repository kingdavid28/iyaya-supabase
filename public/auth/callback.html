<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Authenticating...</title>
    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto",
          "Oxygen", "Ubuntu", "Cantarell", "Fira Sans", "Droid Sans",
          "Helvetica Neue", sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
      }
      .container {
        text-align: center;
        color: white;
      }
      .spinner {
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-top: 4px solid white;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      h1 {
        margin: 0 0 10px 0;
        font-size: 24px;
      }
      p {
        margin: 0;
        font-size: 16px;
        opacity: 0.9;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="spinner"></div>
      <h1>Completing sign in...</h1>
      <p>Please wait while we authenticate you.</p>
    </div>

    <script>
      console.log('üîê OAuth Callback Page Loaded');
      console.log('URL:', window.location.href);
      console.log('Hash:', window.location.hash);
      console.log('Search:', window.location.search);

      // Extract the OAuth callback data from the URL
      const hash = window.location.hash;
      const search = window.location.search;

      // Supabase OAuth sends data in the hash
      // Format: #access_token=...&token_type=Bearer&expires_in=3600&refresh_token=...&type=recovery
      if (hash) {
        console.log('‚úÖ OAuth hash found, redirecting to app');
        
        // Extract access_token from hash
        const hashParams = new URLSearchParams(hash.substring(1));
        const accessToken = hashParams.get('access_token');
        
        if (accessToken) {
          console.log('‚úÖ Access token found');
          // Store for debugging
          localStorage.setItem('oauth_callback_hash', hash);
          localStorage.setItem('oauth_callback_time', new Date().toISOString());
        }
        
        // Redirect to home with hash intact - Supabase will automatically process it
        // This ensures the app receives the OAuth session data
        setTimeout(() => {
          console.log('üîÑ Redirecting to home with OAuth hash...');
          window.location.href = `/${hash}`;
        }, 100);
      } else if (search) {
        console.log('‚úÖ OAuth search params found, redirecting to app');
        
        // Some OAuth flows use search params instead of hash
        setTimeout(() => {
          console.log('üîÑ Redirecting to home with OAuth params...');
          window.location.href = `/?${search}`;
        }, 100);
      } else {
        console.warn('‚ö†Ô∏è No OAuth data found in URL, redirecting to home');
        // No auth params, go straight home after a short delay
        setTimeout(() => {
          window.location.href = '/';
        }, 1000);
      }

      // Timeout - if something goes wrong, go home after 5 seconds
      setTimeout(() => {
        if (window.location.pathname === '/auth/callback') {
          console.error('‚ùå OAuth callback timeout, redirecting to home');
          window.location.href = '/';
        }
      }, 5000);
    </script>
  </body>
</html>
