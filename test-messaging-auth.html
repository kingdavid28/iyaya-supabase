<!DOCTYPE html>
<html>
<head>
    <title>Firebase Messaging Test with Auth</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
    </style>
</head>
<body>
    <h1>Firebase Messaging Test with Authentication</h1>
    <div id="logs"></div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyC7Flwhydbq1qV3tw_QchXr8_5Wg0wOshk",
            authDomain: "iyayav0.firebaseapp.com",
            databaseURL: "https://iyayav0-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "iyayav0",
            storageBucket: "iyayav0.firebasestorage.app",
            messagingSenderId: "433110030942",
            appId: "1:433110030942:web:831e0450381ef9b318f2cf"
        };

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.createElement('div');
            logDiv.className = `log ${type}`;
            logDiv.textContent = `[${timestamp}] ${message}`;
            document.getElementById('logs').appendChild(logDiv);
            console.log(`[${timestamp}] ${message}`);
        }

        async function testMessaging() {
            try {
                log('Initializing Firebase...', 'info');
                firebase.initializeApp(firebaseConfig);
                
                const auth = firebase.auth();
                const database = firebase.database();
                
                log('✅ Firebase initialized successfully', 'success');
                
                // Test anonymous authentication
                log('Attempting anonymous authentication...', 'info');
                try {
                    const userCredential = await auth.signInAnonymously();
                    log(`✅ Anonymous auth successful: ${userCredential.user.uid}`, 'success');
                    
                    // Test database access with auth
                    log('Testing database access with authentication...', 'info');
                    
                    const testRef = database.ref('test-auth');
                    await testRef.set({
                        message: 'Test message with auth',
                        timestamp: Date.now(),
                        user: userCredential.user.uid
                    });
                    
                    log('✅ Write operation successful with auth!', 'success');
                    
                    // Test read operation
                    const snapshot = await testRef.once('value');
                    const data = snapshot.val();
                    log(`✅ Read operation successful: ${JSON.stringify(data)}`, 'success');
                    
                    // Test conversation structure
                    log('Testing conversation structure...', 'info');
                    const conversationId = 'test_conversation';
                    const conversationRef = database.ref(`conversations/${conversationId}`);
                    
                    await conversationRef.set({
                        participants: {
                            [userCredential.user.uid]: true,
                            'test_user_2': true
                        },
                        messages: {
                            'msg_1': {
                                senderId: userCredential.user.uid,
                                text: 'Hello from test!',
                                timestamp: Date.now()
                            }
                        },
                        lastMessage: 'Hello from test!',
                        lastMessageTime: Date.now()
                    });
                    
                    log('✅ Conversation structure test successful!', 'success');
                    
                } catch (authError) {
                    log(`❌ Authentication failed: ${authError.message}`, 'error');
                    log('ℹ️ This might be expected if anonymous auth is disabled', 'info');
                }
                
            } catch (error) {
                log(`❌ Firebase initialization failed: ${error.message}`, 'error');
            }
        }

        // Start the test
        testMessaging();
    </script>
</body>
</html>